<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <title>Métodos de Costeo - TechSolutions</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="stylesheet" href="{% static 'menu.css' %}">
</head>
<body class="cuerpo">
    <header class="contenedor">
        <div class="content">
            <div class="menu container">
                <a href="{% url 'inicio' %}" class="logo">INICIO</a>
                <input type="checkbox" id="menu"/>
                <label for="menu">
                    <img src="{% static 'menu.png' %}" class="menu-icono" alt="Menu">
                </label>
                <nav class="navbar">
                    <ul>
                        <li><a href="{% url 'catalogo_cuentas' %}">Catálogo de Cuentas</a></li>                         
                        <li><a href="{% url 'transacciones' %}">Transacciones</a></li>
                        <li><a href="{% url 'metodos-costeo' %}">Métodos de Costeo</a></li>
                        <li><a href="{% url 'reportes_contables' %}">Reportes Contables</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>  

    <main class="container">
        <h1>Métodos de Costeo</h1>
        <p>En esta sección puedes gestionar los costos indirectos, costos directos y proyectos para el cálculo de costos de los proyectos.</p>

        <!-- Proyectos -->
        <div class="table-container">
            <h2>Proyectos</h2>
            <table>
                <thead>
                    <tr>
                        <th>Número del Proyecto</th>
                        <th>Nombre</th>
                        <th>Duración (meses)</th>
                        <th>Costo Total</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proyecto in proyectos %}
                    <tr>
                        <td>{{ proyecto.id }}</td>
                        <td>{{ proyecto.nombre }}</td>
                        <td>{{ proyecto.duracion_total|floatformat:2 }}</td>
                        <td>${{ proyecto.costo_total|floatformat:2 }}</td>
                        <td>
                            <a href="{% url 'detalle_proyecto' proyecto.id %}" class="button">Ver Detalle</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button onclick="window.location.href='{% url 'nuevo_proyecto' %}'">Agregar Nuevo Proyecto</button>
        </div>

        <!-- Costos Indirectos -->
        <div class="table-container">
            <h2>Costos Indirectos (CI)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Monto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for costo in costos_indirectos %}
                    <tr id="ci-row-{{ costo.id }}">
                        <td><input type="text" name="nombre" value="{{ costo.nombre }}" readonly></td>
                        <td><input type="number" name="monto" value="{{ costo.monto }}" step="0.01" readonly></td>
                        <td>
                            <button type="button" onclick="toggleEdit('ci', {{ costo.id }})" id="ci-btn-{{ costo.id }}">Editar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <form method="post" class="form-inline">
                {% csrf_token %}
                <input type="text" name="nombre" placeholder="Nombre del costo">
                <input type="number" name="monto" placeholder="Monto" step="0.01">
                <button type="submit" name="ci-submit">Agregar Costo Indirecto</button>
            </form>
        </div>

        <!-- Costos Directos -->
        <div class="table-container">
            <h2>Costos Directos (CD)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nombre del Puesto</th>
                        <th>Salario</th>
                        <th>Cantidad de Trabajadores</th>
                        <th>AFP</th>
                        <th>INCAF</th>
                        <th>Seguro Social</th>
                        <th>Vacaciones</th>
                        <th>Aguinaldo</th>
                        <th>Total con Prestaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for puesto in costos_directos %}
                    <tr id="cd-row-{{ puesto.id }}">
                        <td><input type="text" name="nombre" value="{{ puesto.nombre }}" readonly></td>
                        <td><input type="number" name="salario_mensual" value="{{ puesto.salario_mensual }}" step="0.01" readonly></td>
                        <td><input type="number" name="cantidad_empleados" value="{{ puesto.cantidad_empleados }}" readonly></td>
                        <td>${{ puesto.afp|floatformat:2 }}</td>
                        <td>${{ puesto.incaf|floatformat:2 }}</td>
                        <td>${{ puesto.isss|floatformat:2 }}</td>
                        <td>${{ puesto.vacaciones|floatformat:2 }}</td>
                        <td>${{ puesto.aguinaldo|floatformat:2 }}</td>
                        <td>${{ puesto.total_con_prestaciones|floatformat:2 }}</td>
                        <td>
                            <button type="button" onclick="toggleEdit('cd', {{ puesto.id }})" id="cd-btn-{{ puesto.id }}">Editar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <form method="post" class="form-inline">
                {% csrf_token %}
                <input type="text" name="nombre" placeholder="Nombre del puesto">
                <input type="number" name="salario_mensual" placeholder="Salario Mensual" step="0.01">
                <input type="number" name="cantidad_empleados" placeholder="Cantidad de Trabajadores" min="1">
                <button type="submit" name="cd-submit">Agregar Costo Directo</button>
            </form>
        </div>
    </main>

    <script>
        function toggleEdit(type, id) {
            const row = document.getElementById(`${type}-row-${id}`);
            const inputs = row.querySelectorAll("input[name]");
            const button = document.getElementById(`${type}-btn-${id}`);
            
            if (button.innerText === "Editar") {
                inputs.forEach(input => input.removeAttribute("readonly"));
                button.innerText = "Guardar";
                
                const cancelButton = document.createElement("button");
                cancelButton.innerText = "Cancelar";
                cancelButton.type = "button";
                cancelButton.onclick = () => cancelEdit(type, id);
                cancelButton.id = `${type}-cancel-${id}`;
                row.appendChild(cancelButton);
            } else {
                saveChanges(type, id, inputs);
            }
        }

        function saveChanges(type, id, inputs) {
            const url = `/editar-costo-${type === 'ci' ? 'indirecto' : 'directo'}/${id}/`;
            const data = {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            };

            inputs.forEach(input => data[input.name] = input.value);

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(data)
            })
            .then(response => {
                if (response.ok) {
                    inputs.forEach(input => input.setAttribute("readonly", true));
                    document.getElementById(`${type}-btn-${id}`).innerText = "Editar";
                    document.getElementById(`${type}-cancel-${id}`).remove();
                    location.reload();  // Recarga para reflejar cambios
                } else {
                    alert("Error al guardar los cambios");
                }
            });
        }

        function cancelEdit(type, id) {
            const row = document.getElementById(`${type}-row-${id}`);
            const inputs = row.querySelectorAll("input[name]");
            const button = document.getElementById(`${type}-btn-${id}`);
            
            inputs.forEach(input => input.value = input.defaultValue);
            inputs.forEach(input => input.setAttribute("readonly", true));
            
            button.innerText = "Editar";
            document.getElementById(`${type}-cancel-${id}`).remove();
        }
    </script>
</body>
</html>

















